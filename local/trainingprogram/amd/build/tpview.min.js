define("local_trainingprogram/tpview",["exports","local_trainingprogram/dynamicform","core_form/modalform","core/modal_factory","core/modal_events","core/templates","core/ajax","theme_academy/homepage","core/str","jquery"],(function(_exports,_dynamicform,_modalform,_modal_factory,_modal_events,_templates,_ajax,_homepage,_str,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * TODO describe module tpview
   *
   * @module     local_trainingprogram/tpview
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.load=_exports.init=void 0,_dynamicform=_interopRequireDefault(_dynamicform),_modalform=_interopRequireDefault(_modalform),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates),_ajax=_interopRequireDefault(_ajax),_homepage=_interopRequireDefault(_homepage),_jquery=_interopRequireDefault(_jquery);var Selectors_actions={viewprogramsectors:'[data-action="viewprogramsectors"]',currentofferings:'[data-action="currentofferings"]',mapcompetencies:'[data-action="mapcompetencies"]',competencies:'[data-action="competencies"]',programagenda:'[data-action="programagenda"]',viewprogramgoal:'[data-action="viewprogramgoal"]',deleteprogramgoals:'[data-action="deleteprogramgoals"]',addcpd:'[data-action="addcpd"]',edittrainigprogram:'[data-action="edittrainigprogram"]',deletetrainigprogram:'[data-action="deletetrainigprogram"]',showactivities:'[data-action="showactivities"]',viewprogramtopic:'[data-action="viewprogramtrainingtopics"]',addsections:'[data-action="sectionsmapping"]'},HomePage=new _homepage.default;_exports.init=function(){document.addEventListener("click",(function(e){e.stopImmediatePropagation();var viewprogramsectors=e.target.closest(Selectors_actions.viewprogramsectors);if(viewprogramsectors){var programid=viewprogramsectors.getAttribute("data-id");(params={}).programid=programid,_ajax.default.call([{methodname:"local_trainingprogram_viewprogramsectors",args:params}])[0].done((function(resp){_modal_factory.default.create({title:(0,_str.get_string)("viewprogramsectors","local_trainingprogram"),type:_modal_factory.default.types.DEFAULT,body:resp.options}).done(function(modal){this.modal=modal,this.modal.setLarge(),modal.show()}.bind(this))})).fail((function(){console.log("exception")}))}var currentofferings=e.target.closest(Selectors_actions.currentofferings);if(currentofferings){e.stopImmediatePropagation();var _programid=currentofferings.getAttribute("data-id"),sorting=currentofferings.getAttribute("data-sorting");(options={}).programid=_programid,options.sorting=sorting;var trigger=(0,_jquery.default)(Selectors_actions.currentofferings);_modal_factory.default.create({title:(0,_str.get_string)("currentofferings","local_trainingprogram"),body:_templates.default.render("local_trainingprogram/current_offerings_display",options)},trigger).done((function(modal){this.modal=modal,this.modal.setLarge(),this.modal.getRoot().addClass("currentofferingsmodel"),modal.show(),modal.getRoot().on(_modal_events.default.hidden,function(){modal.destroy()}.bind(this))}))}var mapcompetencies=e.target.closest(Selectors_actions.mapcompetencies);if(mapcompetencies){e.preventDefault();var title=(0,_str.get_string)("mapcompetencies","local_trainingprogram"),form=new _dynamicform.default({formClass:"local_trainingprogram\\form\\competenciesform",args:{id:mapcompetencies.getAttribute("data-id")},modalConfig:{title:title},returnFocus:mapcompetencies});form.addEventListener(form.events.FORM_SUBMITTED,(function(){return window.location.reload()})),form.show()}var competencies=e.target.closest(Selectors_actions.competencies);if(competencies){var _programid2=competencies.getAttribute("data-id");(options={}).programid=_programid2;trigger=(0,_jquery.default)(Selectors_actions.competencies);_modal_factory.default.create({title:(0,_str.get_string)("mapcompetencies","local_trainingprogram"),body:_templates.default.render("local_trainingprogram/competencies_display",options)},trigger).done((function(modal){modal.setLarge(),modal.show(),modal.getRoot().on(_modal_events.default.hidden,function(){modal.destroy()}.bind(this))}))}var addcpd=e.target.closest(Selectors_actions.addcpd);if(addcpd){var _programid3=addcpd.getAttribute("data-id");(options={}).programid=_programid3;trigger=(0,_jquery.default)(Selectors_actions.addcpd);_modal_factory.default.create({title:(0,_str.get_string)("addcpd","local_trainingprogram"),body:_templates.default.render("local_trainingprogram/addcpd_display",options)},trigger).done((function(modal){modal.setLarge(),modal.show(),modal.getRoot().on(_modal_events.default.hidden,function(){modal.destroy()}.bind(this))}))}var addtrainigprogram=e.target.closest(Selectors_actions.edittrainigprogram);if(addtrainigprogram){e.preventDefault();var _title=(0,_str.get_string)("addcpd","local_trainingprogram"),_form=new _modalform.default({formClass:"local_trainingprogram\\form\\cpd_form",args:{id:addtrainigprogram.getAttribute("data-ctpid"),prgid:addtrainigprogram.getAttribute("data-prgid")},modalConfig:{title:_title},returnFocus:addtrainigprogram});_form.addEventListener(_form.events.FORM_SUBMITTED,(function(){return window.location.reload()})),_form.show()}var deletetrainigprogram=e.target.closest(Selectors_actions.deletetrainigprogram);if(deletetrainigprogram){var _programid4=deletetrainigprogram.getAttribute("data-id"),programname=deletetrainigprogram.getAttribute("data-name");_modal_factory.default.create({title:(0,_str.get_string)("delete","local_trainingprogram"),type:_modal_factory.default.types.SAVE_CANCEL,body:(0,_str.get_string)("deleteconfirmcpd","local_trainingprogram",programname)}).done(function(modal){this.modal=modal,modal.setSaveButtonText((0,_str.get_string)("delete_cpd","local_trainingprogram")),modal.getRoot().on(_modal_events.default.save,function(e){e.preventDefault();var params={confirm:!0};params.programid=_programid4,_ajax.default.call([{methodname:"local_cpd_delete_training_program",args:params}])[0].done((function(){window.location.reload(!0)})).fail((function(){}))}.bind(this)),modal.show()}.bind(this))}var programagenda=e.target.closest(Selectors_actions.programagenda);if(programagenda){var _programname=programagenda.getAttribute("data-programname"),_title2=(0,_str.get_string)("viewprogramagenda","local_trainingprogram",_programname),_form2=new _dynamicform.default({formClass:"local_trainingprogram\\form\\programagendaform",args:{programid:programagenda.getAttribute("data-programid"),programname:programagenda.getAttribute("data-programname")},modalConfig:{title:_title2},returnFocus:programagenda});_form2.addEventListener(_form2.events.FORM_SUBMITTED,(function(){return window.location.reload()})),_form2.show()}var viewprogramgoal=e.target.closest(Selectors_actions.viewprogramgoal);if(viewprogramgoal){e.stopImmediatePropagation();var options,_programid5=viewprogramgoal.getAttribute("data-programid"),_programname2=viewprogramgoal.getAttribute("data-name");(options={}).programid=_programid5,options.programname=_programname2;trigger=(0,_jquery.default)(Selectors_actions.viewprogramgoal);_modal_factory.default.create({title:(0,_str.get_string)("viewprogramgoal","local_trainingprogram",_programname2),body:_templates.default.render("local_trainingprogram/viewprogramgoalsdisplay",options)},trigger).done((function(modal){this.modal=modal,this.modal.setLarge(),modal.show(),modal.getRoot().on(_modal_events.default.hidden,function(){modal.destroy()}.bind(this))}))}var deleteprogramgoals=e.target.closest(Selectors_actions.deleteprogramgoals);if(deleteprogramgoals){e.preventDefault();var responsibilityid=deleteprogramgoals.getAttribute("data-id");_modal_factory.default.create({title:(0,_str.get_string)("deletelevelconfirm","local_trainingprogram"),type:_modal_factory.default.types.SAVE_CANCEL,body:(0,_str.get_string)("rsponsedeleteconfirm","local_trainingprogram")}).done(function(modal){this.modal=modal,modal.setSaveButtonText((0,_str.get_string)("deletetext","local_trainingprogram")),modal.getRoot().on(_modal_events.default.save,function(e){e.preventDefault();var params={};params.responseid=responsibilityid,_ajax.default.call([{methodname:"deleteprogramgoals",args:params}])[0].done((function(resp){window.location.reload(!0)})).fail((function(){console.log("exception")}))}.bind(this)),modal.show()}.bind(this))}var showactivities=e.target.closest(Selectors_actions.showactivities);if(showactivities){var offeringcode=showactivities.getAttribute("data-code"),_title3=(0,_str.get_string)("todo","local_trainingprogram",offeringcode),_form3=new _dynamicform.default({formClass:"local_trainingprogram\\form\\todoactivities_form",args:{offeringid:showactivities.getAttribute("data-id"),offeringcode:showactivities.getAttribute("data-code"),evaluationmethods:showactivities.getAttribute("data-evaluationmethods")},modalConfig:{title:_title3},returnFocus:showactivities});_form3.addEventListener(_form3.events.FORM_SUBMITTED,(function(){return""})),_form3.show()}var viewprogramtopic=e.target.closest(Selectors_actions.viewprogramtopic);if(viewprogramtopic){var params,_programid6=viewprogramtopic.getAttribute("data-id");(params={}).programid=_programid6,_ajax.default.call([{methodname:"local_trainingprogram_viewprogramtopics",args:params}])[0].done((function(resp){_modal_factory.default.create({title:(0,_str.get_string)("viewprogramtopics","local_trainingprogram"),type:_modal_factory.default.types.DEFAULT,body:resp.options}).done(function(modal){this.modal=modal,this.modal.setLarge(),modal.show()}.bind(this))})).fail((function(){console.log("exception")}))}var sections=e.target.closest(Selectors_actions.addsections);if(sections){var _offeringcode=sections.getAttribute("data-code"),_title4=(0,_str.get_string)("addsections","local_trainingprogram",_offeringcode),_form4=new _dynamicform.default({formClass:"local_trainingprogram\\form\\addsection_form",args:{offeringid:sections.getAttribute("data-id"),offeringcode:sections.getAttribute("data-code")},modalConfig:{title:_title4},returnFocus:sections});_form4.addEventListener(_form4.events.FORM_SUBMITTED,(function(){return""})),_form4.show()}}))};_exports.load=function(tuserid,entityid,referenceid,type){if(isNaN(tuserid)){var params={};params.entityid=entityid,params.referenceid=referenceid,params.tuserid=tuserid,params.type=type,_ajax.default.call([{methodname:"local_exams_get_orgorderdetails",args:params}])[0].done((function(orderdetailsresp){(console.log(orderdetailsresp),"success"==orderdetailsresp.response)?(_templates.default.renderForPromise("tool_product/loader",{}).then((function(_ref){var html=_ref.html,js=_ref.js;_templates.default.appendNodeContents("#region-main-box",html,js)})),1==orderdetailsresp.hasprivateandinvoice?(HomePage.confirmbox((0,_str.get_string)("privateofferingexistsinvoicemessage","local_trainingprogram",orderdetailsresp.existinginvoice_number)),setTimeout((function(){window.location=M.cfg.wwwroot+"/local/trainingprogram/index.php"}),4e3)):""!=orderdetailsresp.returnparams&&1==orderdetailsresp.autoapproval?(event.preventDefault(),_ajax.default.call([{methodname:"tool_product_postpaid_payments",args:{products:orderdetailsresp.returnparams}}])[0].done((function(response){var params={};params.orderid=response.paymentid,_ajax.default.call([{methodname:"tool_product_get_orderinfo",args:params}])[0].done((function(resp){var _this=this;resp&&_ajax.default.call([{methodname:"tool_product_generate_sadadbill",args:{products:resp.info}}])[0].done((function(response){console.log(orderdetailsresp);var enrolparams={};enrolparams.entityid=entityid,enrolparams.referenceid=referenceid,enrolparams.type=type,enrolparams.tuserid=tuserid,enrolparams.orderid=0,enrolparams.discountprice=orderdetailsresp.discountprice,enrolparams.discounttype=orderdetailsresp.discounttype,enrolparams.discounttableid=orderdetailsresp.discounttableid,enrolparams.autoapproval=orderdetailsresp.autoapproval,_ajax.default.call([{methodname:"local_trainingprogram_org_enroluser",args:enrolparams}])[0].done((function(resp){window.location="program"==type?M.cfg.wwwroot+"/local/trainingprogram/index.php":M.cfg.wwwroot+"/local/events/index.php"})).fail((function(){console.log("exception")}))})).fail((function(error){_modal_factory.default.create({title:"",type:_modal_factory.default.types.DEFAULT,body:error.message,footer:'<button type="button" class="btn btn-primary" data-action="save">Ok</button>'}).done(function(modal){this.modal=modal,modal.getFooter().find('[data-action="save"]').on("click",(function(){window.location="program"==type?M.cfg.wwwroot+"/local/trainingprogram/programenrollment.php?programid="+entityid+"&offeringid="+referenceid:M.cfg.wwwroot+"/local/events/attendees.php?id="+entityid,modal.hide()})),modal.show()}.bind(_this))}))})).fail((function(error){HomePage.confirmbox(error.message)}))})).fail((function(error){HomePage.confirmbox(error.error)}))):_ajax.default.call([{methodname:"tool_product_postpaid_payments",args:{products:orderdetailsresp.returnparams}}])[0].done((function(response){var enrolparams={};enrolparams.entityid=entityid,enrolparams.referenceid=referenceid,enrolparams.type=type,enrolparams.tuserid=tuserid,enrolparams.orderid=response.paymentid,enrolparams.discountprice=orderdetailsresp.discountprice,enrolparams.discounttype=orderdetailsresp.discounttype,enrolparams.discounttableid=orderdetailsresp.discounttableid,enrolparams.autoapproval=orderdetailsresp.autoapproval,_ajax.default.call([{methodname:"local_trainingprogram_org_enroluser",args:enrolparams}])[0].done((function(resp){console.log("successfully enrolled"),_modal_factory.default.create({title:(0,_str.get_string)("confirm","local_exams"),type:_modal_factory.default.types.DEFAULT,body:(0,_str.get_string)("ordersubmitted","tool_product")}).done(function(modal){this.modal=modal,modal.show(),window.location="program"==type?M.cfg.wwwroot+"/local/trainingprogram/index.php":M.cfg.wwwroot+"/local/events/index.php"}.bind(this))})).fail((function(){console.log("exception")}))})).fail((function(error){HomePage.confirmbox(error.error)}))):(modal.hide(),HomePage.confirmbox(resp.response))})).fail((function(error){HomePage.confirmbox(error.message)}))}}}));

//# sourceMappingURL=tpview.min.js.map