{"version":3,"file":"entityaction.min.js","sources":["../src/entityaction.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module entityaction\n *\n * @module     local_trainingprogram/entityaction\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Modalform from 'core_form/modalform';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport homepage from 'theme_academy/homepage';\nimport Fragment from 'core/fragment';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\nimport $ from 'jquery';\nconst Selectors = {\n    actions: {\n        cancelentity: '[data-action=\"cancelentity\"]',\n        publishorunpublishentity: '[data-action=\"publishorunpublishentity\"]',\n        update_financially_closed_status: '[data-action=\"update_financially_closed_status\"]',\n    },\n};\nlet HomePage = new homepage();\nexport const init = () => {\n    document.addEventListener('click', function(e) {\n        let cancelentity = e.target.closest(Selectors.actions.cancelentity);\n        if (cancelentity) {\n            e.preventDefault();\n            e.stopImmediatePropagation()\n            const rootid = cancelentity.getAttribute('data-rootid');\n            const fieldid = cancelentity.getAttribute('data-fieldid');\n            const productid = cancelentity.getAttribute('data-productid');\n            const fieldcode = cancelentity.getAttribute('data-fieldcode');\n            const entitytype = cancelentity.getAttribute('data-entitytype');\n            const currentuser = cancelentity.getAttribute('data-currentuser');\n            const costtype = cancelentity.getAttribute('data-costtype');\n            const requestby = cancelentity.getAttribute('data-requestby')\n            const requesttype = cancelentity.getAttribute('data-requesttype')\n            const hasenrollments = cancelentity.getAttribute('data-hasenrollments')\n            var displayparams = {};\n            displayparams.rootid = rootid;\n            displayparams.fieldid = fieldid;\n            displayparams.fieldcode = fieldcode;\n            displayparams.type = entitytype;\n            displayparams.requestby = requestby;\n            displayparams.requesttype = requesttype;\n            if(requesttype =='cancelentity') {\n                var headermessage = getString('cancelconfirm', 'local_trainingprogram');\n                var bodymessage = getString('entitycancelconfirmmessage', 'local_trainingprogram', displayparams);\n            } else if(requesttype =='approvecancelrequest') {\n                var headermessage = getString('approveconfirm', 'local_trainingprogram');\n                var bodymessage = getString('approveentitycancelconfirmmessage', 'local_trainingprogram', displayparams);\n            } else {\n                var headermessage = getString('rejectconfirm', 'local_trainingprogram');\n                var bodymessage = getString('rejectentitycancelconfirmmessage', 'local_trainingprogram', displayparams);\n            }\n            ModalFactory.create({\n                title: headermessage,\n                type: ModalFactory.types.SAVE_CANCEL,\n                body: bodymessage\n            }).done(function(modal) {\n                this.modal = modal;\n                modal.setSaveButtonText(getString('yes', 'local_trainingprogram'));\n                modal.getRoot().on(ModalEvents.save, function(e) {\n                    e.preventDefault();\n                    Templates.renderForPromise('tool_product/loader', {}).then(({html, js}) => {\n                        Templates.appendNodeContents('.modal-content', html, js);\n                    });\n                    if(requesttype =='cancelentity') {\n                        const title = getString('reasoncancel', 'local_exams');\n                        const form = new Modalform({\n                            formClass: 'local_exams\\\\form\\\\reasonform',\n                            args: {entitytype: entitytype, userid: 0, productid: productid},\n                            modalConfig: {title},\n                            returnFocus: cancelentity,\n                        });\n                        form.addEventListener(form.events.FORM_SUBMITTED, (event) => {\n                            const data = event.detail;\n                            var params = {};\n                            params.rootid = rootid;\n                            params.fieldid = fieldid;\n                            params.productid = productid;\n                            params.fieldcode = fieldcode;\n                            params.entitytype = entitytype;\n                            params.costtype = costtype;\n                            params.currentuser = currentuser;\n                            params.requesttype =requesttype;\n                            params.hasenrollments =hasenrollments;\n                            var promise = Ajax.call([{\n                                methodname: 'local_trainingprogram_cancelentity',\n                                args: params\n                            }]);\n                            promise[0].done(function(resp) {\n                                if(resp.response == 'success') {\n                                    if(currentuser =='admin' || ((currentuser =='ts' || currentuser == 'eventmanager') && (requesttype == 'approvecancelrequest' || requesttype == 'rejectcancelrequest'))) { \n                                        window.location.href = resp.returnurl;\n                                    } else {\n                                        if(currentuser =='financial_manager') {\n                                          var bodayMessage  = getString('tofficialcancelresponse', 'local_trainingprogram',displayparams);\n                                        } else {\n                                            if(entitytype == 'event') {\n\n                                                var bodayMessage  =  getString('emcancelresponse', 'local_trainingprogram',displayparams);\n\n                                            } else {\n                                                if(hasenrollments == 1) {\n                                                    var bodayMessage  =  getString('faofficialcancelresponse', 'local_trainingprogram',displayparams);\n                                                } else {\n                                                    var bodayMessage  =  getString('tofficialcancelresponse', 'local_trainingprogram',displayparams);\n                                                }\n                                            }\n                                            \n                                        }\n                                        HomePage.confirmbox(bodayMessage);\n                                        setTimeout(function() {\n                                            location.reload();\n                                        },4000);\n                                    }   \n                                } else {\n                                    modal.hide();\n                                    HomePage.confirmbox(resp.response);\n                                }\n                            }).fail(function(err) {\n                                HomePage.confirmbox(err.message);\n                            });\n                                \n                        });\n                        form.show();\n                    } else {\n                       \n                        var params = {};\n                        params.rootid = rootid;\n                        params.fieldid = fieldid;\n                        params.productid = productid;\n                        params.fieldcode = fieldcode;\n                        params.entitytype = entitytype;\n                        params.costtype = costtype;\n                        params.currentuser = currentuser;\n                        params.requesttype =requesttype;\n                        params.hasenrollments =hasenrollments;\n                        var promise = Ajax.call([{\n                            methodname: 'local_trainingprogram_cancelentity',\n                            args: params\n                        }]);\n                        promise[0].done(function(resp) {\n                            if(resp.response == 'success') {\n                                if(currentuser =='admin' || ((currentuser =='ts' || currentuser == 'eventmanager') && (requesttype == 'approvecancelrequest' || requesttype == 'rejectcancelrequest'))) { \n                                    window.location.href = resp.returnurl;\n                                } else {\n                                    if(currentuser =='financial_manager') {\n                                        var bodayMessage  = getString('tofficialcancelresponse', 'local_trainingprogram',displayparams);\n                                      } else {\n                                        if(entitytype == 'event') {\n\n                                        var bodayMessage  =  getString('emcancelresponse', 'local_trainingprogram',displayparams);\n\n                                        } else {\n                                            if(hasenrollments == 1) {\n                                                var bodayMessage  =  getString('faofficialcancelresponse', 'local_trainingprogram',displayparams);\n                                            } else {\n                                                var bodayMessage  =  getString('tofficialcancelresponse', 'local_trainingprogram',displayparams);\n                                            }\n                                        }\n                                          \n                                      }\n                                    HomePage.confirmbox(bodayMessage);\n                                    setTimeout(function() {\n                                        location.reload();\n                                    },4000);\n                                }   \n                            } else {\n                                modal.hide();\n                                HomePage.confirmbox(resp.response);\n                            }\n                        }).fail(function(err) {\n                            HomePage.confirmbox(err.message);\n                        });\n\n                    }\n                   \n                }.bind(this));\n                modal.show();\n            }.bind(this));\n        }\n\n        let publishorunpublishentity = e.target.closest(Selectors.actions.publishorunpublishentity);\n        if (publishorunpublishentity) {\n             e.preventDefault();\n            const id = publishorunpublishentity.getAttribute('data-id');\n            const code = publishorunpublishentity.getAttribute('data-code');\n            const entitytype = publishorunpublishentity.getAttribute('data-entitytype');\n            const actiontype = publishorunpublishentity.getAttribute('data-actiontype');\n            var displayparams = {};\n            displayparams.code = code;\n            displayparams.entitytype = entitytype;\n            if(actiontype =='publish') {\n                var headermessage = getString('publishconfirm', 'local_trainingprogram');\n                var bodymessage = getString('entitypublishconfirm', 'local_trainingprogram',displayparams);\n                var footermessage = getString('publishtext', 'local_trainingprogram');\n            } else {\n                var headermessage = getString('unpublishconfirm', 'local_trainingprogram');\n                var bodymessage = getString('entityunpublishconfirm', 'local_trainingprogram',displayparams);\n                var footermessage = getString('unpublishtext', 'local_trainingprogram');\n            }\n            ModalFactory.create({\n                title: headermessage,\n                type: ModalFactory.types.SAVE_CANCEL,\n                body: bodymessage\n            }).done(function(modal) {\n                this.modal = modal;\n                modal.setSaveButtonText(footermessage);\n                modal.getRoot().on(ModalEvents.save, function(e) {\n                    e.preventDefault();\n                    var params = {};\n                    params.id = id;\n                    params.code = code;\n                    params.entitytype = entitytype;\n                    params.actiontype = actiontype;\n                    var promise = Ajax.call([{\n                        methodname: 'local_trainingprogram_publishorunpublishoffering',\n                        args: params\n                    }]);\n                    promise[0].done(function(resp) {\n                        window.location.reload(true);\n                    }).fail(function() {\n                        console.log('exception');\n                    });\n                }.bind(this));\n                modal.show();\n            }.bind(this));\n        }\n        let update_financially_closed_status = e.target.closest(Selectors.actions.update_financially_closed_status);\n        if (update_financially_closed_status) {\n             e.preventDefault();\n            const id = update_financially_closed_status.getAttribute('data-id');\n            const code = update_financially_closed_status.getAttribute('data-code');\n            const actiontype = update_financially_closed_status.getAttribute('data-actiontype');\n\n            if(actiontype =='open_fc_offering') {\n                var headermessage = getString('open_fc_confirm', 'local_trainingprogram');\n                var bodymessage = getString('openfcofferingconfirm', 'local_trainingprogram',code);\n                var footermessage = getString('yes', 'local_trainingprogram');\n            } else {\n                var headermessage = getString('close_fc_confirm', 'local_trainingprogram');\n                var bodymessage = getString('closefcofferingconfirm', 'local_trainingprogram',code);\n                var footermessage = getString('yes', 'local_trainingprogram');\n            }\n            ModalFactory.create({\n                title: headermessage,\n                type: ModalFactory.types.SAVE_CANCEL,\n                body: bodymessage\n            }).done(function(modal) {\n                this.modal = modal;\n                modal.setSaveButtonText(footermessage);\n                modal.getRoot().on(ModalEvents.save, function(e) {\n                    e.preventDefault();\n                    var params = {};\n                    params.id = id;\n                    params.code = code;\n                    params.actiontype = actiontype;\n                    var promise = Ajax.call([{\n                        methodname: 'local_trainingprogram_update_offering_financially_closed_status',\n                        args: params\n                    }]);\n                    promise[0].done(function(resp) {\n                        window.location.reload(true);\n                    }).fail(function() {\n                        console.log('exception');\n                    });\n                }.bind(this));\n                modal.show();\n            }.bind(this));\n        }\n    });\n};\n"],"names":["Selectors","cancelentity","publishorunpublishentity","update_financially_closed_status","HomePage","homepage","document","addEventListener","e","target","closest","preventDefault","stopImmediatePropagation","rootid","getAttribute","fieldid","productid","fieldcode","entitytype","currentuser","costtype","requestby","requesttype","hasenrollments","displayparams","type","headermessage","bodymessage","create","title","ModalFactory","types","SAVE_CANCEL","body","done","modal","setSaveButtonText","getRoot","on","ModalEvents","save","renderForPromise","then","html","js","appendNodeContents","form","Modalform","formClass","args","userid","modalConfig","returnFocus","events","FORM_SUBMITTED","event","detail","params","Ajax","call","methodname","resp","response","bodayMessage","confirmbox","setTimeout","location","reload","window","href","returnurl","hide","fail","err","message","show","bind","this","id","code","actiontype","footermessage","console","log"],"mappings":"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"}