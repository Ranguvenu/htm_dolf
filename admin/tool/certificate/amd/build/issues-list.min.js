/**
 * AMD module used when viewing the list of issued certificates
 *
 * @module     tool_certificate/issues-list
 * @copyright  2019 Marina Glancy
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("tool_certificate/issues-list",["jquery","tool_certificate/modal_form","core/notification","core/str","core/ajax","core/toast"],(function($,ModalForm,Notification,Str,Ajax,Toast){const SELECTORS_ADDISSUE="[data-element='addbutton']",SELECTORS_REGENERATEFILE="[data-action='regenerate']",SELECTORS_REVOKEISSUE="[data-action='revoke']",SELECTORS_CHECKALL='[data-action="checkall"]',SELECTORS_ISSUEFORSELECTEDUSERS='[data-action="issueforselectedusers"]',SELECTORS_ISSUEFORALLUSERS='[data-action="issueforallusers"]',SELECTORS_UNCHECKALL='[data-action="uncheckall"]';function makeModalSmall(){var a=document.querySelector(".modal-lg");if(a)return a.classList.remove("modal-lg"),!0}var addIssue=function(e){e.preventDefault();var page;page=$(e.currentTarget).attr("data-page");var examid=$(e.currentTarget).attr("data-examid"),userid=$(e.currentTarget).attr("data-userid"),element=$(e.currentTarget).attr("data-element"),modal=new ModalForm({formClass:"tool_certificate\\form\\certificate_issues",args:{tid:$(e.currentTarget).attr("data-tid"),page:page,examid:examid,userid:userid,element:element},modalConfig:{title:Str.get_string("issuecertificates","tool_certificate"),scrollable:!1},saveButtonText:Str.get_string("save"),triggerElement:$(e.currentTarget)});if(page){var intervalId=setInterval(makeModalSmall,200);setTimeout((function(){clearInterval(intervalId),console.log("Interval stopped!")}),1e4)}modal.onSubmitSuccess=function(data){(data=parseInt(data,10))?(Str.get_strings([{key:"oneissuewascreated",component:"tool_certificate"},{key:"aissueswerecreated",component:"tool_certificate",param:data}]).done((function(s){var str=data>1?s[1]:s[0];Toast.add(str)})),window.location.reload()):Str.get_string("noissueswerecreated","tool_certificate").done((function(s){Toast.add(s)}))}},revokeIssue=function(e){e.preventDefault(),e.stopPropagation(),Str.get_strings([{key:"confirm",component:"moodle"},{key:"revokecertificateconfirm",component:"tool_certificate"},{key:"revoke",component:"tool_certificate"},{key:"cancel",component:"moodle"}]).done((function(s){Notification.confirm(s[0],s[1],s[2],s[3],(function(){Ajax.call([{methodname:"tool_certificate_revoke_issue",args:{id:$(e.currentTarget).attr("data-id")}}])[0].done((function(){window.location.reload()})).fail(Notification.exception)}))})).fail(Notification.exception)},regenerateIssueFile=function(e){e.preventDefault(),e.stopPropagation(),Str.get_strings([{key:"confirm",component:"moodle"},{key:"regeneratefileconfirm",component:"tool_certificate"},{key:"regenerate",component:"tool_certificate"},{key:"cancel",component:"moodle"}]).done((function(s){Notification.confirm(s[0],s[1],s[2],s[3],(function(){Ajax.call([{methodname:"tool_certificate_regenerate_issue_file",args:{id:$(e.currentTarget).attr("data-id")}}])[0].done((function(){window.location.reload()})).fail(Notification.exception)}))})).fail(Notification.exception)},checkall=function(e){document.querySelectorAll(".user-checkbox").forEach((function(usercheckbox){usercheckbox.checked=!0})),$(e.currentTarget).attr("data-action","uncheckall")},uncheckall=function(e){document.querySelectorAll(".user-checkbox").forEach((function(usercheckbox){usercheckbox.checked=!1})),$(e.currentTarget).attr("data-action","checkall")},issueforselectedusers=function(e){e.preventDefault();var allcheckboxes=document.querySelectorAll(".user-checkbox"),arrexamids=[],checkedids=[];if(allcheckboxes.forEach((function(usercheckbox){usercheckbox.checked&&(checkedids.push(usercheckbox.getAttribute("data-userid")),arrexamids.push(usercheckbox.getAttribute("data-examid")))})),checkedids.length<1){var title=Str.get_string("alert","tool_certificate"),message=Str.get_string("usernotselected","tool_certificate"),ok=Str.get_string("ok");Notification.alert(title,message,ok)}else{var page=$(e.currentTarget).attr("data-page"),userids=checkedids.join(","),examids=arrexamids.join(",");if(new ModalForm({formClass:"tool_certificate\\form\\certificate_issues",args:{tid:$(e.currentTarget).attr("data-tid"),page:$(e.currentTarget).attr("data-page"),examid:examids,userid:userids,element:$(e.currentTarget).attr("data-action")},modalConfig:{title:Str.get_string("issuecertificates","tool_certificate"),scrollable:!1},saveButtonText:Str.get_string("sure","tool_certificate"),triggerElement:$(e.currentTarget)}).onSubmitSuccess=function(data){(data=parseInt(data,10))?(Str.get_strings([{key:"oneissuewascreated",component:"tool_certificate"},{key:"aissueswerecreated",component:"tool_certificate",param:data}]).done((function(s){var str=data>1?s[1]:s[0];Toast.add(str)})),window.location.reload()):Str.get_string("noissueswerecreated","tool_certificate").done((function(s){Toast.add(s)}))},page){var intervalId=setInterval(makeModalSmall,200);setTimeout((function(){clearInterval(intervalId),console.log("Interval stopped!")}),1e4)}}},issueforallusers=function(e){const tid=$(e.currentTarget).attr("data-tid"),element=$(e.currentTarget).attr("data-action");Ajax.call([{methodname:"tool_certificate_issue_certificate_for_all",args:{status:!0,tid:tid,element:element}}])[0].done((function(resp){if(console.log(resp),resp.userids){new ModalForm({formClass:"tool_certificate\\form\\certificate_issues",args:{tid:tid,page:"exam_certificate",examid:resp.examids,userid:resp.userids,element:resp.element},modalConfig:{title:Str.get_string("issuecertificates","tool_certificate"),scrollable:!1},saveButtonText:Str.get_string("sure","tool_certificate"),triggerElement:$(e.currentTarget)}).onSubmitSuccess=function(data){(data=parseInt(data,10))?(Str.get_strings([{key:"oneissuewascreated",component:"tool_certificate"},{key:"aissueswerecreated",component:"tool_certificate",param:data}]).done((function(s){var str=data>1?s[1]:s[0];Toast.add(str)})),window.location.reload()):Str.get_string("noissueswerecreated","tool_certificate").done((function(s){Toast.add(s)}))};var intervalId=setInterval(makeModalSmall,200);setTimeout((function(){clearInterval(intervalId),console.log("Interval stopped!")}),1e4)}else{var title=Str.get_string("alert","tool_certificate"),message=Str.get_string("nousercompletionfound","tool_certificate"),ok=Str.get_string("ok");Notification.alert(title,message,ok)}})).fail(Notification.exception)};return{init:function(){$("body").on("click",SELECTORS_ADDISSUE,addIssue).on("click",SELECTORS_REVOKEISSUE,revokeIssue).on("click",SELECTORS_REGENERATEFILE,regenerateIssueFile).on("click",SELECTORS_CHECKALL,checkall).on("click",SELECTORS_ISSUEFORSELECTEDUSERS,issueforselectedusers).on("click",SELECTORS_ISSUEFORALLUSERS,issueforallusers).on("click",SELECTORS_UNCHECKALL,uncheckall)}}}));

//# sourceMappingURL=issues-list.min.js.map