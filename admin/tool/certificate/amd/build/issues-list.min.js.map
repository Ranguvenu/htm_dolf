{"version":3,"file":"issues-list.min.js","sources":["../src/issues-list.js"],"sourcesContent":["// This file is part of the tool_certificate plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module used when viewing the list of issued certificates\n *\n * @module     tool_certificate/issues-list\n * @copyright  2019 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery',\n        'tool_certificate/modal_form',\n        'core/notification',\n        'core/str',\n        'core/ajax',\n        'core/toast'],\nfunction($,\n         ModalForm,\n         Notification,\n         Str,\n         Ajax,\n         Toast) {\n\n    const SELECTORS = {\n        ADDISSUE: \"[data-element='addbutton']\",\n        REGENERATEFILE: \"[data-action='regenerate']\",\n        REVOKEISSUE: \"[data-action='revoke']\",\n        CHECKALL: '[data-action=\"checkall\"]',\n        ISSUEFORSELECTEDUSERS: '[data-action=\"issueforselectedusers\"]',\n        ISSUEFORALLUSERS: '[data-action=\"issueforallusers\"]',\n        UNCHECKALL: '[data-action=\"uncheckall\"]',\n    };\n    // Define the function to be executed\n    function makeModalSmall() {\n        var a = document.querySelector('.modal-lg');\n        if (a) {\n            a.classList.remove('modal-lg');\n            return true;\n        }\n    }\n    /**\n     * Add issue dialogue\n     * @param {Event} e\n     */\n    var addIssue = function(e) {\n        e.preventDefault();\n        var page = '';\n        page = $(e.currentTarget).attr('data-page');\n        var examid = $(e.currentTarget).attr('data-examid');\n        var userid = $(e.currentTarget).attr('data-userid');\n        var element = $(e.currentTarget).attr('data-element');\n        \n        var modal = new ModalForm({\n            formClass: 'tool_certificate\\\\form\\\\certificate_issues',\n            args: {\n                tid: $(e.currentTarget).attr('data-tid'),\n                page : page,\n                examid: examid,\n                userid: userid,\n                element: element\n            },\n            modalConfig: {\n                title: Str.get_string('issuecertificates', 'tool_certificate'), \n                scrollable: false\n            },\n            saveButtonText: Str.get_string('save'),\n            triggerElement: $(e.currentTarget),\n        });\n        \n\n        if (page) {\n            // Call setInterval to execute the function every 2 seconds\n            var intervalId = setInterval(makeModalSmall, 200);\n\n            // To stop the interval execution after a certain time (e.g., 10 seconds)\n            setTimeout(function() {\n              clearInterval(intervalId);\n              console.log('Interval stopped!');\n            }, 10000);\n        }\n        modal.onSubmitSuccess = function(data) {\n            data = parseInt(data, 10);\n            if (data) {\n                Str.get_strings([\n                    {key: 'oneissuewascreated', component: 'tool_certificate'},\n                    {key: 'aissueswerecreated', component: 'tool_certificate', param: data}\n                ]).done(function(s) {\n                    var str = data > 1 ? s[1] : s[0];\n                    Toast.add(str);\n                });\n                window.location.reload();\n            } else {\n                Str.get_string('noissueswerecreated', 'tool_certificate')\n                    .done(function(s) {\n                        Toast.add(s);\n                    });\n            }\n        };\n\n    };\n\n    /**\n     * Revoke issue\n     * @param {Event} e\n     */\n    var revokeIssue = function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        Str.get_strings([\n            {key: 'confirm', component: 'moodle'},\n            {key: 'revokecertificateconfirm', component: 'tool_certificate'},\n            {key: 'revoke', component: 'tool_certificate'},\n            {key: 'cancel', component: 'moodle'}\n        ]).done(function(s) {\n            Notification.confirm(s[0], s[1], s[2], s[3], function() {\n                var promises = Ajax.call([\n                    {methodname: 'tool_certificate_revoke_issue',\n                        args: {id: $(e.currentTarget).attr('data-id')}}\n                ]);\n                promises[0].done(function() {\n                    window.location.reload();\n                }).fail(Notification.exception);\n            });\n        }).fail(Notification.exception);\n    };\n\n    /**\n     * Revoke issue\n     * @param {Event} e\n     */\n    var regenerateIssueFile = function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        Str.get_strings([\n            {key: 'confirm', component: 'moodle'},\n            {key: 'regeneratefileconfirm', component: 'tool_certificate'},\n            {key: 'regenerate', component: 'tool_certificate'},\n            {key: 'cancel', component: 'moodle'}\n        ]).done(function(s) {\n            Notification.confirm(s[0], s[1], s[2], s[3], function() {\n                var promises = Ajax.call([\n                    {methodname: 'tool_certificate_regenerate_issue_file',\n                        args: {id: $(e.currentTarget).attr('data-id')}}\n                ]);\n                promises[0].done(function() {\n                    window.location.reload();\n                }).fail(Notification.exception);\n            });\n        }).fail(Notification.exception);\n    };\n    /**\n     * CHECK ALL USERS\n     * \n     */\n    var checkall = function (e) {\n        var allcheckboxes = document.querySelectorAll('.user-checkbox');\n        var arrexamids = [];\n        allcheckboxes.forEach(function(usercheckbox){\n            usercheckbox.checked = true;\n        });\n        $(e.currentTarget).attr('data-action', 'uncheckall')\n    }\n    /**\n     * UN-CHECK ALL USERS\n     * \n     */\n    var uncheckall = function (e) {\n        var allcheckboxes = document.querySelectorAll('.user-checkbox');\n        var arrexamids = [];\n        allcheckboxes.forEach(function(usercheckbox){\n            usercheckbox.checked = false;\n        });\n        $(e.currentTarget).attr('data-action', 'checkall')\n    }\n    var issueforselectedusers = function(e) {\n        e.preventDefault();\n        var allcheckboxes = document.querySelectorAll('.user-checkbox');\n        var arrexamids = [];\n        var checkedids = [];\n        allcheckboxes.forEach(function(usercheckbox){\n            if(usercheckbox.checked){\n                checkedids.push(usercheckbox.getAttribute('data-userid'));\n                arrexamids.push(usercheckbox.getAttribute('data-examid'));\n            }\n        });\n        if (checkedids.length < 1) {\n            var title = Str.get_string('alert', 'tool_certificate');\n            var message = Str.get_string('usernotselected', 'tool_certificate');\n            var ok = Str.get_string('ok');\n            Notification.alert(title, message, ok);\n        }else{\n            var page = $(e.currentTarget).attr('data-page');\n            var userids = checkedids.join(',');\n            var examids = arrexamids.join(',');\n            var modal = new ModalForm({\n                formClass: 'tool_certificate\\\\form\\\\certificate_issues',\n                args: {\n                    tid: $(e.currentTarget).attr('data-tid'),\n                    page : $(e.currentTarget).attr('data-page'),\n                    examid: examids,\n                    userid: userids,\n                    element: $(e.currentTarget).attr('data-action')\n                },\n                modalConfig: {\n                    title: Str.get_string('issuecertificates', 'tool_certificate'), \n                    scrollable: false\n                },\n                saveButtonText: Str.get_string('sure','tool_certificate'),\n                triggerElement: $(e.currentTarget),\n            });\n            modal.onSubmitSuccess = function(data) {\n                data = parseInt(data, 10);\n                if (data) {\n                    Str.get_strings([\n                        {key: 'oneissuewascreated', component: 'tool_certificate'},\n                        {key: 'aissueswerecreated', component: 'tool_certificate', param: data}\n                    ]).done(function(s) {\n                        var str = data > 1 ? s[1] : s[0];\n                        Toast.add(str);\n                    });\n                    window.location.reload();\n                } else {\n                    Str.get_string('noissueswerecreated', 'tool_certificate')\n                        .done(function(s) {\n                            Toast.add(s);\n                        });\n                }\n            };\n            if (page) {\n                // Call setInterval to execute the function every 2 seconds\n                var intervalId = setInterval(makeModalSmall, 200);\n\n                // To stop the interval execution after a certain time (e.g., 10 seconds)\n                setTimeout(function() {\n                  clearInterval(intervalId);\n                  console.log('Interval stopped!');\n                }, 10000);\n            }\n        }\n    }\n    var issueforallusers = function(e) {\n        const tid = $(e.currentTarget).attr('data-tid');\n        const element = $(e.currentTarget).attr('data-action');\n        var page = '';\n        page = 'exam_certificate';\n        var promises = Ajax.call([{\n            methodname: 'tool_certificate_issue_certificate_for_all',\n            args: {status:true, tid: tid, element: element}\n        }]);\n        promises[0].done(function(resp) {\n            console.log(resp);\n            if (resp.userids) {\n                var modal = new ModalForm({\n                    formClass: 'tool_certificate\\\\form\\\\certificate_issues',\n                    args: {\n                        tid: tid,\n                        page : 'exam_certificate',\n                        examid: resp.examids,\n                        userid: resp.userids,\n                        element: resp.element\n                    },\n                    modalConfig: {\n                        title: Str.get_string('issuecertificates', 'tool_certificate'), \n                        scrollable: false\n                    },\n                    saveButtonText: Str.get_string('sure','tool_certificate'),\n                    triggerElement: $(e.currentTarget),\n                });\n                modal.onSubmitSuccess = function(data) {\n                    data = parseInt(data, 10);\n                    if (data) {\n                        Str.get_strings([\n                            {key: 'oneissuewascreated', component: 'tool_certificate'},\n                            {key: 'aissueswerecreated', component: 'tool_certificate', param: data}\n                        ]).done(function(s) {\n                            var str = data > 1 ? s[1] : s[0];\n                            Toast.add(str);\n                        });\n                        window.location.reload();\n                    } else {\n                        Str.get_string('noissueswerecreated', 'tool_certificate')\n                            .done(function(s) {\n                                Toast.add(s);\n                            });\n                    }\n                };\n                if (page) {\n                    // Call setInterval to execute the function every 2 seconds\n                    var intervalId = setInterval(makeModalSmall, 200);\n\n                    // To stop the interval execution after a certain time (e.g., 10 seconds)\n                    setTimeout(function() {\n                      clearInterval(intervalId);\n                      console.log('Interval stopped!');\n                    }, 10000);\n                }\n            }else{\n                var title = Str.get_string('alert', 'tool_certificate');\n                var message = Str.get_string('nousercompletionfound', 'tool_certificate');\n                var ok = Str.get_string('ok');\n                Notification.alert(title, message, ok);\n            }\n        }).fail(Notification.exception);\n    }\n    return {\n        /**\n         * Init page\n         */\n        init: function() {\n            // Add button is not inside a tab, so we can't use Tab.addButtonOnClick .\n            $('body')\n                .on('click', SELECTORS.ADDISSUE, addIssue)\n                .on('click', SELECTORS.REVOKEISSUE, revokeIssue)\n                .on('click', SELECTORS.REGENERATEFILE, regenerateIssueFile)\n                .on('click', SELECTORS.CHECKALL, checkall)\n                .on('click', SELECTORS.ISSUEFORSELECTEDUSERS, issueforselectedusers)\n                .on('click', SELECTORS.ISSUEFORALLUSERS, issueforallusers)\n                .on('click', SELECTORS.UNCHECKALL, uncheckall);\n        }\n    };\n});\n"],"names":["define","$","ModalForm","Notification","Str","Ajax","Toast","SELECTORS","makeModalSmall","a","document","querySelector","classList","remove","addIssue","e","preventDefault","page","currentTarget","attr","examid","userid","element","modal","formClass","args","tid","modalConfig","title","get_string","scrollable","saveButtonText","triggerElement","intervalId","setInterval","setTimeout","clearInterval","console","log","onSubmitSuccess","data","parseInt","get_strings","key","component","param","done","s","str","add","window","location","reload","revokeIssue","stopPropagation","confirm","call","methodname","id","fail","exception","regenerateIssueFile","checkall","querySelectorAll","forEach","usercheckbox","checked","uncheckall","issueforselectedusers","allcheckboxes","arrexamids","checkedids","push","getAttribute","length","message","ok","alert","userids","join","examids","issueforallusers","status","resp","init","on"],"mappings":"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"}